name: template_update

permissions:
  contents: write

on:
  workflow_call:
    inputs:
      template_repo:
        description: 'URL of the cookiecutter template repo'
        required: true
        type: string
      repo_branch:
        description: 'Branch of the project repo to update'
        required: true
        type: string

jobs:
  template-update:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the target branch (full history, able to push)
      - name: Checkout project repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ inputs.repo_branch }}
          persist-credentials: true

      # 2. Set up Python & install deps
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: pip install cookiecutter jq

      # 3. Read old template SHA
      - name: Read old template SHA
        id: get_old_sha
        run: |
          OLD_SHA=$(jq -r '.cookiecutter.template_sha // empty' .cookiecutter.json)
          if [ -z "$OLD_SHA" ]; then
            echo "::error ::.cookiecutter.json is missing cookiecutter.template_sha"
            exit 1
          fi
          echo "old_sha=$OLD_SHA" >> $GITHUB_OUTPUT

      # 4. Fetch new template SHA
      - name: Fetch new template SHA
        id: get_new_sha
        run: |
          NEW_SHA=$(git ls-remote "${{ inputs.template_repo }}" HEAD | cut -f1)
          echo "new_sha=$NEW_SHA" >> $GITHUB_OUTPUT

      # 5. Exit if unchanged
      - name: Skip if template unchanged
        run: |
          if [ "${{ steps.get_old_sha.outputs.old_sha }}" = "${{ steps.get_new_sha.outputs.new_sha }}" ]; then
            echo "Template SHA unchanged; exiting."
            exit 0
          fi

      # 6. Clone both template versions
      - name: Clone base template at OLD SHA
        run: |
          git clone "${{ inputs.template_repo }}" base-template
          pushd base-template
            git checkout "${{ steps.get_old_sha.outputs.old_sha }}"
          popd
      - name: Clone new template at HEAD
        run: git clone "${{ inputs.template_repo }}" template-source

      # 7. Determine sub-template path
      - name: Determine sub-template path
        id: template_path
        run: |
          ASP=$(jq -r '.cookiecutter.is_aspire // "no"' .cookiecutter.json)
          DOC=$(jq -r '.cookiecutter.is_docker // "no"' .cookiecutter.json)
          if [ "$ASP" = "yes" ]; then
            echo "path=aspire-project" >> $GITHUB_OUTPUT
          elif [ "$DOC" = "yes" ]; then
            echo "path=docker-project" >> $GITHUB_OUTPUT
          else
            echo "::error ::No valid sub-template in .cookiecutter.json" && exit 1
          fi

      # 8a. Render base (old) template
      - name: Generate base template output
        run: |
          rm -rf ~/.cookiecutters/*
          mkdir -p template-base
          cookiecutter ./base-template \
            --directory "${{ steps.template_path.outputs.path }}" \
            --replay-file .cookiecutter.json \
            --overwrite-if-exists \
            --output-dir template-base

      # 8b. Render new template
      - name: Generate new template output
        run: |
          rm -rf ~/.cookiecutters/*
          mkdir -p template-new
          cookiecutter ./template-source \
            --directory "${{ steps.template_path.outputs.path }}" \
            --replay-file .cookiecutter.json \
            --overwrite-if-exists \
            --output-dir template-new

      # 9. Create unified diff
      - name: Create update.patch
        run: |
          diff -ruN \
            template-base/${{ steps.template_path.outputs.path }} \
            template-new/${{ steps.template_path.outputs.path }} \
            > update.patch || true

      # 10. Apply patch (exit on conflicts)
      - name: Apply patch if changes
        id: apply_patch
        run: |
          if [ ! -s update.patch ]; then
            echo "No template changes detected; exiting."
            exit 0
          fi
          if ! git apply --index --3way update.patch; then
            echo "::error ::Merge conflicts detected; aborting."
            exit 1
          fi

      # 11. Optional cleanup of temp directories
      - name: Cleanup temporary files
        run: rm -rf base-template template-source template-base template-new update.patch

      # 12. Optional: set Git author
      - name: Configure Git author
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      # 13. Compute and export the new branch name
      - name: Set update branch name
        id: make_branch
        run: |
          echo "UPDATE_BRANCH=template-update-${{ steps.get_new_sha.outputs.new_sha }}" >> $GITHUB_ENV

      # 14. Create & checkout that branch
      - name: Create update branch
        run: git checkout -b $UPDATE_BRANCH

      # 15. Bump template_sha in the JSON
      - name: Bump template_sha
        run: |
          jq ".cookiecutter.template_sha = \"${{ steps.get_new_sha.outputs.new_sha }}\"" \
            .cookiecutter.json > tmp.json && mv tmp.json .cookiecutter.json

      # 16. Commit the bump (only if changes)
      - name: Commit changes
        run: |
          git add .cookiecutter.json
          # only create a commit if the file actually changed
          git diff --cached --quiet || git commit -m "chore: bump template_sha to ${{ steps.get_new_sha.outputs.new_sha }}"

      # 17. Push the update branch
      - name: Push update branch
        run: git push origin $UPDATE_BRANCH

      # 18. Open a PR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token:     ${{ secrets.GITHUB_TOKEN }}
          base:      ${{ inputs.repo_branch }}
          branch:    ${{ env.UPDATE_BRANCH }}
          title:     "chore: merge template updates ${{ steps.get_old_sha.outputs.old_sha }} â†’ ${{ steps.get_new_sha.outputs.new_sha }}"
          body: |
            This PR updates the cookiecutter template SHA:
            - old: ${{ steps.get_old_sha.outputs.old_sha }}
            - new: ${{ steps.get_new_sha.outputs.new_sha }}
          labels: template-update
